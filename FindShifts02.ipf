#pragma rtGlobals=1		// Use modern global access method.// MODIFICATION HISTORY --  THIS MUST BE UPDATED TO SUMMARIZE CHANGES//// 12/9/08   "Revise" Checkbox added to Initial Shifts Panel//      If unchecked,  then "Next" button will take position of  N-1-th shift point as the//                    initial point for the Nth frame.//      If checked, then we assume that the shift has already been set previously, and "Next"//           takes the current shift position of the Nth frame.    This is to prevent loss of previous setting.//         "Previous" button always takes the current value to avoid loss of previous setting.//12/9/08   InitializeTempShiftVars()  now takes an argument for file  to allow flexibility for//    which point is plotted initially// 12/5/08:   Based on InspectAndUpdate (V20) from Trapping Code//static strconstant  ksRhodFileRoot = "RHOD"  // for 2-digit namesstatic strconstant  ksRhodFileRoot = "RHOD"  // for 3-digit names// ---------        FindInitialShifts()  ---------// 12/5/08 Based on InspectAndUpdateOneFrameV3function  FindInitialShifts(ctrlName): ButtonControl    string ctrlName    // temporary storage variables    make/O/N= (1) XT, YT        variable i,TrapOcc, c1f,c2f    string s1    variable/G  ifG    NVAR ActiveTempPoint1    NVAR LPX, LPY, RPX, RPY    SVAR RootString, ShiftString    string AttTemp="Att_"+RootString    ActiveTempPoint1 = -1        Variable f1=0, f2=1    Prompt f1, "Enter First File Index"    Prompt f2, "Enter Last File Index"    DoPrompt "Indexes", f1, f2    if (V_flag==1)	      	return 0    endif    ShiftString="Shift"+RootString    LoadWave/Q/O/P=ToPractice (ShiftString+".ibw")    LoadWave/G/Q/N='Abts'/O/P=ToPractice (AttTemp+".txt")    wave Abts0    Variable RAngle=Abts0[2]    Duplicate/O $ShiftString SSInitCalib    variable ifile, shX, shY          variable/G firstfileG = f1  // to pass to button routines    variable/G lastfileG = f2    variable/G ifileShiftsG = f1            // initialize info for plotting etc    initializeTempShiftVars(firstfileG)             plot1file()// create and start using control panel for running through images	DoWindow/K InitialShiftPanel	NewPanel/K=1/N=InitialShiftPanel/W=(700,50,1100,210)  // 6/12/08	string/G iuTitlestr	variable line1 = 10; variable line2 = 60; variable line3 = 90; variable line4 = 150;	variable line5=215; variable updateline=260; 	variable NcellsLine = 300	variable cell0line  =325; variable cell1line =350; variable cell2line =375	variable cell3line =400; variable cell4line =425; variable cell5line =450	variable savecancelline = 475	variable lastline = 120		Execute "ModifyPanel cbRGB=(56797,56797,56797)"	sprintf iuTitlestr "Current frame %d     First %d  Last %d", f1, f1,f2	TitleBox iuTitle,title=iuTitleStr,pos={50,line1}       Button MoveLeftRightPoints, pos = {240, line2}, size = {100,20}, title = "Move  Points", proc = MoveLRPoints                    variable cellxpos = 50; variable cellypos = 140              SetVariable Shiftx,pos ={cellxpos,line2}, size = {80,17}, limits={0,Inf,1},value=XT[0]       SetVariable Shifty,pos ={cellypos,line2}, size = {80,17}, limits={0,Inf,1},value=YT[0]       CheckBox InitialOrReview,pos={cellxpos,line3},size={60,20},title="Revise",value=0         //       SetAddMoveButtons()       // 5/14/07                Button NextFileButton, pos={10,lastline}, size ={100,20},title = "Next File", proc = NextFileButton        Button PreviousFileButton, pos={120,lastline}, size ={100,20},title = "Previous File", proc = PreviousFileButton        Button DoneButtonShifts, pos={230,lastline}, size ={100,20},title = "Done", proc = DoneButtonShifts              PauseForUser InitialShiftPanel, Step1 end//---------------NextFileButton() -----------------//12/5/08  based on NextTrapButton()function NextFileButton(CtrlName): ButtonControl    string CtrlName        NVAR ifileShiftsG, firstfileG, lastfileG    string s1    variable ifile1    //   Do any data storage bookkeeping here on current trap    NVAR ActiveTempPoint1    if (ActiveTempPoint1 != -1)   // cursor is active        print "Error in NextFileButton:  Cursor is active\r"    else        SaveTempShiftVars()  // record temporary variables            if (ifileShiftsG == lastfileG)            print "Already at last file"        else    //  go to next file            ifileShiftsG +=1    // do any other needed panel updating            sprintf  s1 	"Current frame %d     First %d  Last %d", ifileShiftsG, firstfileG, lastfileG           TitleBox iuTitle, title = s1        // initial setup and plot of the new file            ControlInfo InitialOrReview            if(V_Value==0)                ifile1 = ifileShiftsG-1  //  12/9/08on initial setting, plot previous frame's shift point            else                ifile1 = ifileShiftsG     // on review, plot current frame's shift point            endif            initializeTempShiftVars(ifile1)  // 12/9/08                      plot1file()            DoWindow/F InitialShiftPanel  // bugfix 8/30/07         endif     endifend//---------------PreviousFileButton() -----------------//12/5/08  based on PreviousTrapButton()function PreviousFileButton(CtrlName): ButtonControl    string CtrlName        NVAR ifileShiftsG, firstfileG, lastfileG    string s1    //   Do any data storage bookkeeping here on current trap    NVAR ActiveTempPoint1    if (ActiveTempPoint1 != -1)   // cursor is active        print "Error in PreviousTrapButton:  Cursor is active\r"    else        SaveTempShiftVars()  // record temporary variables        if (ifileShiftsG == firstfileG)            print "Already at first file"        else    //  go to previous file           ifileShiftsG -=1    // do any other needed panel updating            sprintf  s1 	"Current frame %d     First %d  Last %d", ifileShiftsG, firstfileG, lastfileG           TitleBox iuTitle, title = s1    // initial plot of the new file            initializeTempShiftVars(ifileShiftsG)  // 12/9/08  always plot current value of previous frame                    plot1file()            DoWindow/F InitialShiftPanel  // bugfix 8/30/07          endif     endifend//--------------------- DoneButtonShifts ------------------//12/5/08Function DoneButtonShifts(ctrlName) : ButtonControl  //Done Button string ctrlName    SVAR RootString, ShiftString    WAVE SSinitCalib           NVAR ifileShiftsG    NVAR ActiveTempPoint1    variable finishanyway = 1    if (ActiveTempPoint1 != -1)   // cursor is active        print "Error in DoneButtonShifts:  Cursor is active\r"        finishanyway = 0        Prompt finishanyway "Set=1 to finish anyway"        DoPrompt "Error in DoneButtonShifts:  Cursor is active", finishanyway    endif   if (finishanyway == 1)        SaveTempShiftVars()  // record temporary variables        DoWindow/K InitialShiftPanel       DoWindow/K Step1 // 6/12/08 cleanup              Duplicate/O SSInitCalib $ShiftString, ShiftsCopy       Save/O/C/P=ToPractice  $ShiftString as (ShiftString+".ibw")  // The path is temporary	Save/O/C/P=ToPractice  ShiftsCopy as ("ShiftsCopy.ibw")//Duplicate shift string, so that shifts are not lost, when define array is run again    endifend//------------------InitializeTempShiftVars()//12/9/08  takes file index as argument for greater flexibilityFunction InitializeTempShiftVars(ifile1)    variable ifile1        WAVE abts0, XT,YT,SSInitCalib        XT[0] = abts0[0] + SSInitCalib[ifile1][10]     YT[0] = abts0[1] + SSInitCalib[ifile1][11] end//------------------SaveTempShiftVars()Function SaveTempShiftVars()    NVAR ifileShiftsG, firstfileG, lastfileG    WAVE XT,YT    WAVE SSInitCalib, abts0    SSInitCalib[ifileShiftsG][10] = XT[0] - abts0[0]  // shift relative to first file    SSInitCalib[ifileShiftsG][11] = YT[0] - abts0[1]  // shift relative to first fileend// -----------------Plot1File()Function Plot1File()       NVAR ifileShiftsG     WAVE abts0, XT,YT,SSInitCalib    string s1        variable testtest = iFileShiftsG      sprintf s1, "%s%03d.tif", ksRhodFileRoot,ifileShiftsG   // 4/3/07    ImageLoad/P=MovieFolder/T=tiff/O/N=image1 s1    ImageRotate/A=(abts0[2]) image1   // Rangle    Duplicate/O M_RotatedImage image1    DoWindow/K Step1	    NewImage/N=Step1 image1    ModifyImage image1 ctab = {Abts0[6],Abts0[7],Grays,0}  // zmin, zmax       // overplot marker point     Appendtograph/T YT vs XT     ModifyGraph mode(YT)=3, rgb(YT)=(65535,0,0)   //redend// -----------------ReloadShifts//This just allows you to reload shifts that you already put in by hand, if you had to go back to define array and thereby erased your shiftsfunction ReloadShifts(ctrlname)string ctrlnameSvar ShiftStringWave SSInitCalib,ShiftsCopyLoadWave/O/P=ToPractice "ShiftsCopy.ibw"SSInitCalib[][10] = ShiftsCopy[p][10]SSInitCalib[][11]=ShiftsCopy[p][11] Duplicate/O SSInitCalib $ShiftStringend